<!-- 
<!DOCTYPE html>
<html>
<head>

    <script type="text/javascript">window.languagePluginUrl = 'https://pyodide-cdn2.iodide.io/v0.15.0/full/';</script>
    <script src="https://pyodide-cdn2.iodide.io/v0.15.0/full/pyodide.js"></script>

</head>
<body>
    <input type="file" onchange="doit();" id="file">
    <script type="text/javascript">
    var content = null;

    function doit() {
        // https://github.com/pyodide/pyodide/issues/679
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = evt => { 
            content = evt.target.result; 
            var output = pyodide.runPython('from js import content\ncontent');
            var l = output.length;
            var array = new Uint8Array(l);
            for (var i = 0; i < l; i++) {
                array[i] = output.charCodeAt(i);
            }
            var blob = new Blob([array], {type: 'application/octet-stream'});
            var elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = 'output.pdf';
            document.body.appendChild(elem);
            elem.click();        
            document.body.removeChild(elem);
        }
    }

    languagePluginLoader.then(function () {
        console.log('Ready');
    });
    </script>
</body>
 -->





<!doctype html>
<html>
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Floyd–Steinberg dithering online</title>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
  </head>

  <body>

    <textarea id="output" class="console" disabled></textarea>

    <div class="container">
      <div class="row">

        <div class="col left-side">
          <div class="title-container">
            <span class="title-name">Floyd–Steinberg dithering online</span> <br>
            made by <a href="https://github.com/rynkuns">rynkuns <span class="bi bi-github"></span></a>
          </div>
          <div class="site-desc">
            <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo.</p>
          </div>
          <div>
            <div class="parameters">
              <input type="file" onchange="readImageFile(this);" id="file">
            </div>
            <div class="parameters">
              <label for="range-n-clusters">No. of colours to split image into</label><br>
              <span id="valueNClusters" class="slider-value">5</span>
              <input type="range" min="2" max="20" value="5" id="range-n-clusters" step="1" class="slider" oninput="valueNClusters.innerText = this.value">
            </div>
            <div class="parameters">
              <label for="range-n-init">No. of times the image will be clustered<br>
                <i class="bi bi-exclamation-triangle"></i> <span style="font-size: 80%;">Higher values may bring better results on the cost of processing time.</span></label><br>
              <span id="valueNInit" class="slider-value">1</span>
              <input type="range" min="1" max="7" value="1" id="range-n-init" step="1" class="slider" oninput="valueNInit.innerText = this.value">
            </div>
            <div class="parameters">
              <button onclick="startDithering()">start</button>
            </div>
          </div>
          <div>
            <br>Please note that this is a static site and all calculations happen on your device.<br>None of your data is stored online.
          </div>
        </div>

        <div class="col-md">
          <div id="image-one" class="image-container">
            <div class="image-label">the original image</div>
            <img id="uploaded_image" src="empty.png"/>
          </div>
          <div id="image-two" class="image-container">
            <div class="image-label">without dithering</div>
            <img id="mid_image" src="empty.png"/>
          </div>
          <div id="image-three" class="image-container">
            <div class="image-label">with dithering</div>
            <img id="final_image" src="empty.png"/>
          </div>
        </div>

      </div>
    </div>















    <footer class="footer">
      <div class="container">
          <div class="row">
            <div class="col"><a href="#projects-container"><span class="bi bi-journal-code"></span></a></div> 
            <div class="col"><a href="#"><span class="bi bi-journal-text"></span></a></div> 
            <div class="col"><span class="bi bi-slash"></span></div> 
            <div class="col"><a href="mailto:szymon.rynkun+homepage@gmail.com"><span class="bi bi-envelope"></span></a></div>
            <div class="col"><a href="https://www.linkedin.com/in/szymon-rynkun/"><span class="bi bi-linkedin"></span></a></div>
            <div class="col"><a href="https://github.com/rynkuns"><span class="bi bi-github"></span></a></div>
          </div> <!-- Bootstrap icons -->
      </div>
  </footer>




    <!-- SCRIPTS -->

    <script>
      const output = document.getElementById("output");
      const code = document.getElementById("code");



      function addToOutput(s) {
        output.value += s + "\n";
      }




      output.value = "Initializing Python...\n";
      async function main() {
        let pyodide = await loadPyodide();

        addToOutput("Loading packages...")
        await pyodide.loadPackage("pillow")
        await pyodide.loadPackage("numpy")
        await pyodide.loadPackage("scikit-learn")

        pyodide.runPython(`
          from PIL import Image
          import numpy as np
          from sklearn.cluster import KMeans

          from io import BytesIO
          import base64
        `)
        addToOutput("All complete. Ready!")
        return pyodide;
      }
      let pyodideReadyPromise = main();


      

      async function evaluatePython() {
        let pyodide = await pyodideReadyPromise;
        try {
          let output = pyodide.runPython(code.value);
          addToOutput(output);
        } catch (err) {
          addToOutput(err);
        }
      }



      var image_file = null;
      async function readImageFile(input) {
        let pyodide = await pyodideReadyPromise; 

        let file = input.files[0]; 
        let fileReader = new FileReader(); 
        // fileReader.readAsArrayBuffer(file);
        fileReader.readAsBinaryString(file);
        // readAsArrayBuffer

        fileReader.onload = function() {
          image_file = fileReader.result;
          let xxx = pyodide.runPython(`
            from js import image_file
            obraz = Image.open(BytesIO(bytes(ord(c) for c in image_file))).convert("RGB") ### key moment here
            obraz
          `)  
          // addToOutput(xxx);
          addToOutput("Image loaded.");

          uploaded_img_str = pyodide.runPython(`
            image_buf = BytesIO()
            obraz.save(image_buf, format='png')
            image_buf.seek(0)
            uploaded_img_str = 'data:image/png;base64,' + base64.b64encode(image_buf.read()).decode('UTF-8')
            uploaded_img_str
          `);
          document.getElementById("uploaded_image").src=uploaded_img_str

        }; 
        fileReader.onerror = function() {
          alert(fileReader.error);
        }; 
      }


      

      async function startDithering() {
        let pyodide = await pyodideReadyPromise;

        addToOutput("Clustering and dithering in progress...");
        pyodide.runPython(`

          czy_FSteinberg = True ######### DAĆ TU OPCJE Z JSa
          l_klast = 5 ######### TO SAMO !
          cluster_n_init = 1 ######### TO SAMO !

          pixele = []
          for y in range(obraz.size[1]):
              for x in range(obraz.size[0]):
                  pixele.append(obraz.getpixel((x,y)))        
          klastry = KMeans(n_clusters=l_klast, random_state=0, n_init=cluster_n_init).fit(pixele)

          indeks = klastry.labels_ #lista, do któego klastra należy dany pixel
          kolor = klastry.cluster_centers_.astype(int) #wybrane przezalgorytm kolory
          mapa = obraz.load()

          if czy_FSteinberg:
              def korektor(pierwotny, korekta, waga):
                  """Funkcja przyjmuje wartość pierwotną pixela, oraz wyliczoną wartość błędu z poprzedniego pixela,
                    a następnie aplikuje ją z odpowiednią wagą i zwraca."""
                  nowy = []
                  for i in range(3):
                      nowy.append(int(pierwotny[i] + korekta[i]*waga))
                  return tuple(nowy)
                  

              for y in range(obraz.size[1]-1):       #faktyczny proces cieniowa algorytmem
                  for x in range(1,obraz.size[0]-2):
                      oryginalny = obraz.getpixel((x,y))
                      nowy = kolor[klastry.predict(np.array(oryginalny).reshape(1, -1))][0]
                      mapa[x,y] = tuple(nowy)
                      buond = np.array([oryginalny[0] - nowy[0], oryginalny[1] - nowy[1], oryginalny[2] - nowy[2]]) #błąd przybliżenia (w skali RGB)
                      mapa[x+1,y] = korektor(obraz.getpixel((x+1,y)), buond, 7/16)
                      mapa[x-1,y+1] = korektor(obraz.getpixel((x-1,y+1)), buond, 3/16)
                      mapa[x,y+1] = korektor(obraz.getpixel((x,y+1)), buond, 5/16)
                      mapa[x+1,y+1] = korektor(obraz.getpixel((x+1,y+1)), buond, 1/16)
                      #powyżej dodawanie wartości błędu do sąsiadujących pixeli (zgodnie z algorytmem)
                      
          else: #no dithering
              n = 0
              for y in range(obraz.size[1]):
                  for x in range(obraz.size[0]):
                      mapa[x,y] = tuple(kolor[indeks[n]])
                      n+=1
        `)

        addToOutput("Dithering complete!");
        // https://stackoverflow.com/questions/56583696/how-to-redirect-render-pyodide-output-in-browser
        final_img_str = pyodide.runPython(`
          image_buf = BytesIO()
          obraz.save(image_buf, format='png')
          image_buf.seek(0)
          final_img_str = 'data:image/png;base64,' + base64.b64encode(image_buf.read()).decode('UTF-8')
          final_img_str
        `)
        document.getElementById("final_image").src=final_img_str
      }









/*       var content = null;

      async function doit() {
        let pyodide = await pyodideReadyPromise;
        // https://github.com/pyodide/pyodide/issues/679
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = evt => { 
            content = evt.target.result; 
            var output = pyodide.runPython('from js import content\ncontent');
            var l = output.length;
            var array = new Uint8Array(l);
            for (var i = 0; i < l; i++) {
                array[i] = output.charCodeAt(i);
            }
            var blob = new Blob([array], {type: 'application/octet-stream'});
            var elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = 'output.pdf';
            document.body.appendChild(elem);
            elem.click();        
            document.body.removeChild(elem);
        }
    } */


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>

  </body>
</html>
